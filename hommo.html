<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="KHOZZA Admin Panel to manage orders." />
    <meta name="author" content="KHOZZA" />
    <meta name="keywords" content="admin panel, KHOZZA, order management" />
    <title>KHOZZA • Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Cinzel:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --card: #0f0f0f;
            --muted: #bfb6a0;
            --accent: #d4af37;
            --secondary: #2a2a2a;
            --text-primary: #ffffff;
            --text-muted: #8f8872;
            --error: #ff4d4d;
        }
        body {
            background: var(--bg);
            color: var(--text-primary);
            font-family: Inter, Arial, sans-serif;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        h2 {
            color: var(--accent);
            font-family: 'Cinzel', serif;
            font-size: 28px;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow-x: auto;
            display: block;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        th {
            color: var(--accent);
            font-weight: 600;
            background: var(--secondary);
        }
        td {
            color: var(--muted);
        }
        select, button, input {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: #0b0b0b;
            color: var(--text-primary);
            cursor: pointer;
        }
        button {
            background: var(--accent);
            color: #000;
            border: none;
            margin: 5px;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            background: #c19a2f;
            transform: translateY(-2px);
        }
        .whatsapp-btn {
            background: #25D366;
            color: #fff;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
        }
        .whatsapp-btn:hover {
            background: #20b358;
            transform: translateY(-2px);
        }
        .error {
            color: var(--error);
            font-weight: 600;
            text-align: center;
            margin: 10px 0;
        }
        #loading {
            display: none;
            color: var(--accent);
            text-align: center;
            margin: 10px 0;
        }
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        #authContainer {
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            max-width: 400px;
            width: 100%;
            margin-top: 50px;
        }
        #authContainer p {
            color: var(--muted);
            margin-bottom: 20px;
        }
        #authContainer input {
            text-align: center;
            margin-bottom: 15px;
        }
        #authContainer button {
            width: 100%;
            padding: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="authContainer">
            <h2>Admin Login</h2>
            <p>Enter your admin email to receive a secure login link.</p>
            <input type="email" id="adminEmail" placeholder="admin@example.com" />
            <button onclick="sendLoginLink()">Send Login Link</button>
            <div id="authMessage" style="margin-top: 15px; color: var(--accent);"></div>
            <div id="errorMessage" class="error"></div>
        </div>

        <div id="mainAdminPanel" style="display:none;">
            <h2>KHOZZA Admin Panel</h2>
            <div style="text-align: right; margin-bottom: 20px;">
                <button onclick="logout()">Logout</button>
            </div>
            
            <div id="error" class="error"></div>
            <div id="loading">Loading orders...</div>
            
            <table id="orderTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Products</th>
                        <th>Qty</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Pincode</th>
                        <th>UPI Ref</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Cancel Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orderList"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyB7G-qFuj4e3H_UsTDTundsNlGyHQshEbo",
            authDomain: "admin-64dbd.firebaseapp.com",
            projectId: "admin-64dbd",
            storageBucket: "admin-64dbd.firebasestorage.app",
            messagingSenderId: "629728527109",
            appId: "1:629728527109:web:b44d10cbe8170021462d6c",
            measurementId: "G-EMP3S14ET1"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut, 
            sendSignInLinkToEmail,
            isSignInWithEmailLink,
            signInWithEmailLink 
        } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, query } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // REMOVED: const ADMIN_EMAIL = 'khozzafassion@gmail.com';

        const authContainer = document.getElementById('authContainer');
        const mainAdminPanel = document.getElementById('mainAdminPanel');
        const authMessage = document.getElementById('authMessage');
        const errorMessage = document.getElementById('errorMessage');

        const actionCodeSettings = {
            url: window.location.href,
            handleCodeInApp: true,
        };

        // Handle login link when the page loads
        if (isSignInWithEmailLink(auth, window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) {
                // If email is missing, ask the user again
                email = window.prompt('Please provide your email for confirmation:');
            }
            if (email) {
                signInWithEmailLink(auth, email, window.location.href)
                    .then(() => {
                        window.localStorage.removeItem('emailForSignIn');
                        // The onAuthStateChanged listener will handle panel visibility
                    })
                    .catch((error) => {
                        errorMessage.textContent = `Login failed: ${error.message}. Make sure your email is authorized in Firebase Rules.`;
                    });
            } else {
                errorMessage.textContent = 'Login cancelled: Email confirmation is required.';
            }
        }

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Panel is shown if a user is logged in. 
                // Access to data is still controlled by Firestore Security Rules.
                authContainer.style.display = 'none';
                mainAdminPanel.style.display = 'block';
                loadOrders();
            } else {
                authContainer.style.display = 'block';
                mainAdminPanel.style.display = 'none';
            }
        });

        window.sendLoginLink = async () => {
            const email = document.getElementById('adminEmail').value.trim();
            errorMessage.textContent = '';
            authMessage.textContent = '';

            if (!email) {
                errorMessage.textContent = 'Please enter your admin email.';
                return;
            }

            try {
                // Now, any email can receive a link, but only authorized emails 
                // (via Firebase Rules) will see data after login.
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                window.localStorage.setItem('emailForSignIn', email);
                authMessage.textContent = `A login link has been sent to ${email}. Check your inbox!`;
                document.getElementById('adminEmail').value = ''; // Clear input for security
            } catch (error) {
                errorMessage.textContent = `Error sending link: ${error.message}`;
            }
        };

        function sanitizePhoneNumber(phone) {
            if (!phone) return '';
            return phone.replace(/[^0-9]/g, '');
        }

        function loadOrders() {
            const loadingElement = document.getElementById('loading');
            const orderListElement = document.getElementById('orderList');
            const errorElement = document.getElementById('error');
            const orderTable = document.getElementById('orderTable');

            loadingElement.style.display = 'block';
            orderTable.style.display = 'none';

            // Query without hardcoded email check in client code
            const ordersCollection = collection(db, "orders");

            onSnapshot(ordersCollection, (snapshot) => {
                orderListElement.innerHTML = '';
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (orders.length === 0) {
                    orderListElement.innerHTML = '<tr><td colspan="12">No orders found.</td></tr>';
                } else {
                    orderListElement.innerHTML = orders.map(order => {
                        const productsHTML = Array.isArray(order.cartItems) ? order.cartItems.map(item => `
                            <li>${item.name || 'Unknown'} (${item.qty || 1} pcs) - Size: ${item.size || 'N/A'}, Color: ${item.color || 'N/A'}</li>
                        `).join('') : 'No products';
                        const totalQty = Array.isArray(order.cartItems) ? order.cartItems.reduce((acc, item) => acc + (item.qty || 0), 0) : 'N/A';
                        const sanitizedPhone = sanitizePhoneNumber(order.phone);
                        const whatsappMessage = encodeURIComponent(
                            `Order Update\nOrder ID: ${order.orderId || 'N/A'}\nCustomer: ${order.name || 'N/A'}\nPhone: ${order.phone || 'N/A'}\nProducts:\n${Array.isArray(order.cartItems) ? order.cartItems.map(item => `${item.name || 'Unknown'} x ${item.qty || 1}`).join('\n') : 'N/A'}\nAddress: ${order.address || 'N/A'}, ${order.pincode || 'N/A'}\nUPI Ref: ${order.upiRef || 'N/A'}\nTotal: ₹${order.totalAmount ? order.totalAmount.toFixed(2) : 'N/A'}\nStatus: ${order.status || 'N/A'}\nCancel Reason: ${order.cancel_reason || 'N/A'}`
                        );
                        const whatsappUrl = sanitizedPhone ? `https://wa.me/${sanitizedPhone}?text=${whatsappMessage}` : '#';
                        return `
                            <tr>
                                <td>${order.orderId || 'N/A'}</td>
                                <td><ul style="padding-left: 20px;">${productsHTML}</ul></td>
                                <td>${totalQty}</td>
                                <td>${order.name || 'N/A'}</td>
                                <td>${order.phone || 'N/A'}</td>
                                <td>${order.address || 'N/A'}</td>
                                <td>${order.pincode || 'N/A'}</td>
                                <td>${order.upiRef || 'N/A'}</td>
                                <td>₹${order.totalAmount ? order.totalAmount.toFixed(2) : 'N/A'}</td>
                                <td>
                                    <select onchange="updateStatus('${order.id}', this.value)">
                                        <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                                        <option value="Your Payment is Confirmed" ${order.status === 'Your Payment is Confirmed' ? 'selected' : ''}>Your Payment is Confirmed</option>
                                        <option value="Order Confirmed" ${order.status === 'Order Confirmed' ? 'selected' : ''}>Order Confirmed</option>
                                        <option value="Packed" ${order.status === 'Packed' ? 'selected' : ''}>Packed</option>
                                        <option value="Shipped" ${order.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                                        <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                        <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" id="cancelReason_${order.id}" placeholder="Enter reason" value="${order.cancel_reason || ''}" onchange="updateCancelReason('${order.id}', this.value)">
                                </td>
                                <td>
                                    <a href="${whatsappUrl}" class="whatsapp-btn" target="_blank" ${!sanitizedPhone ? 'style="pointer-events:none;opacity:0.5;"' : ''}>Message</a>
                                    <button onclick="deleteOrder('${order.id}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                loadingElement.style.display = 'none';
                orderTable.style.display = 'table';
            }, (error) => {
                // If a non-admin tries to load data, Firebase Rules will block it and cause an error here.
                errorElement.textContent = `Failed to load orders: Access denied or network error. Please check your login. (${error.code || error.message})`;
                loadingElement.style.display = 'none';
                orderTable.style.display = 'none';
            });
        }

        window.updateStatus = async (orderId, newStatus) => {
            const errorElement = document.getElementById('error');
            try {
                await updateDoc(doc(db, "orders", orderId), { status: newStatus });
                errorElement.textContent = 'Status updated successfully!';
                setTimeout(() => errorElement.textContent = '', 3000);
            } catch (error) {
                errorElement.textContent = `Failed to update status: ${error.code || error.message}`;
            }
        };

        window.updateCancelReason = async (orderId, newReason) => {
            const errorElement = document.getElementById('error');
            try {
                await updateDoc(doc(db, "orders", orderId), { cancel_reason: newReason });
                errorElement.textContent = 'Cancel reason updated successfully!';
                setTimeout(() => errorElement.textContent = '', 3000);
            } catch (error) {
                errorElement.textContent = `Failed to update cancel reason: ${error.code || error.message}`;
            }
        };

        window.deleteOrder = async (orderId) => {
            const errorElement = document.getElementById('error');
            if (!confirm('Are you sure you want to delete this order?')) return;
            try {
                await deleteDoc(doc(db, "orders", orderId));
                errorElement.textContent = 'Order deleted successfully!';
                setTimeout(() => errorElement.textContent = '', 3000);
            } catch (error) {
                errorElement.textContent = `Failed to delete order: ${error.code || error.message}`;
            }
        };

        window.logout = () => {
            const errorElement = document.getElementById('error');
            signOut(auth).then(() => {
                window.location.reload(); // Reload to show login screen
            }).catch(error => {
                errorElement.textContent = `Failed to log out: ${error.code || error.message}`;
            });
        };
    </script>
</body>
</html>
