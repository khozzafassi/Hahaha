<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHOZZA • Secure Checkout</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&family=Cinzel:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        :root { 
            --bg: #050505; --card: #0f0f0f; --muted: #bfb6a0; --accent: #d4af37; 
            --secondary: #2a2a2a; --text-primary: #ffffff; --error: #f44336; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text-primary); font-family: 'Inter', sans-serif; min-height: 100vh; line-height: 1.5; }
        header { display: flex; align-items: center; justify-content: space-between; padding: 20px 28px; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top:0; background: var(--bg); z-index:1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .logo { font-family: 'Cinzel', serif; font-size:22px; color: var(--accent); letter-spacing:2px; font-weight:600; text-transform:uppercase; }
        .header-right { display:flex; align-items:center; gap:12px; }
        .cart-btn { background: var(--accent); color:#000; padding:8px 16px; border-radius:50px; font-weight:600; text-decoration:none; display:flex; align-items:center; gap:8px; transition: background 0.3s, transform 0.2s; }
        .cart-btn:hover { background:#c19a2f; transform:translateY(-2px); }
        .hamburger { display:none; font-size:26px; cursor:pointer; color: var(--accent); }
        nav { display:flex; gap:18px; }
        nav a { color: var(--muted); text-decoration:none; font-weight:600; position:relative; transition: color 0.3s, transform 0.2s; }
        nav a:hover { color: var(--accent); transform:translateY(-2px); }
        @media(max-width:768px){ header{padding:16px 24px;} nav{ display:none; flex-direction:column; position:absolute; top:70px; right:24px; background:var(--card); padding:15px; border-radius:12px; width:200px; box-shadow:0 4px 20px rgba(0,0,0,0.3);} nav.show{display:flex;} .hamburger{display:block;} }
        .wrap { max-width:900px; margin:28px auto; padding:20px; }
        .card { background:var(--card); border:1px solid rgba(255,255,255,0.1); padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
        h2 { font-family:'Cinzel', serif; color: var(--accent); margin-bottom:14px; font-size:24px; }
        #upiSection h2 { font-size: 18px; line-height: 1.4; }
        label{display:block;color:var(--muted);margin:8px 0 4px;font-weight:600;}
        input, textarea, select { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:#0b0b0b; color:var(--text-primary); transition:border 0.3s; }
        input:focus, textarea:focus, select:focus { border-color:var(--accent); outline:none; }
        .row{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px;}
        .checkout-btn{ background:var(--accent); color:#000; padding:12px 18px; border:none; border-radius:50px; font-weight:600; cursor:pointer; text-align:center; transition: background 0.3s, transform 0.2s; }
        .checkout-btn:hover{ background:#c19a2f; transform:translateY(-2px);}
        .secondary-btn{background:var(--secondary); color:var(--muted); padding:12px 18px; border:1px solid rgba(255,255,255,0.1); border-radius:50px; font-weight:600; cursor:pointer; text-align:center; transition: background 0.3s, transform 0.2s;}
        .secondary-btn:hover{background:rgba(255,255,255,0.1); transform:translateY(-2px);}
        #loadingOverlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; font-size:24px; color:var(--text-primary); z-index:1000;}
        #countdown{font-size:36px; margin-top:10px;}
        #upiSection{display:none; margin-top:20px;}
        #upiSection img{max-width:220px; margin-bottom:10px; border-radius:8px;}
        #upiSection .priceDisplay{font-size:28px; font-weight:600; color:var(--accent); margin-bottom:10px; text-align:right;}
        #orderConfirm{display:none; margin-top:20px;}
        .copyBtn{ background:#d32f2f; color:#fff; margin-top:8px; display:inline-block; padding:8px 12px; border-radius:8px; cursor:pointer; transition: background 0.3s, transform 0.2s;}
        .error-message { color: var(--error); margin-top: 4px; font-size: 14px; }
        [aria-invalid="true"] { border-color: var(--error) !important; }
        ul.product-list{list-style:none;padding:0;}
        ul.product-list li{margin-bottom:8px; display:flex; gap:10px; align-items:center;}
        ul.product-list li img{width:60px; height:60px; object-fit:cover; border-radius:6px;}
        #productSummary .priceDisplay { font-size: 28px; font-weight: 600; color: var(--accent); text-align: right; margin-top: 12px; }
        .track-btn {
            background: #242424;
            color: #e7e0cc;
            padding: 12px 18px;
            border: 1px solid #2d2d2d;
            border-radius: 50px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            margin-top: 15px;
            transition: background 0.3s, transform 0.2s;
        }
        .track-btn:hover {
             background: #333;
             transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">KHOZZA</div>
        <div class="header-right">
            <a href="cart.html" class="cart-btn"><i class="fas fa-arrow-left"></i> Edit Cart</a>
            <div class="hamburger" onclick="toggleMenu()" aria-label="Toggle navigation menu" role="button" aria-expanded="false" aria-controls="nav">
                <i class="fas fa-bars"></i>
            </div>
        </div>
        <nav id="nav">
            <a href="index.html">Home</a>
            <a href="wallets.html">Wallets</a>
            <a href="watches.html">Watch Boxes</a>
            <a href="fashion.html">Fashion</a>
            <a href="about.html">About</a>
            <a href="privacy.html">Privacy</a>
            <a href="contact.html">Contact</a>
        </nav>
    </header>

    <div class="wrap">
        <div class="card" id="checkoutCard">
            <h2>Secure Checkout</h2>
            <div id="productSummary"></div>

            <label for="name">Full Name</label>
            <input id="name" type="text" placeholder="Your name">
            <div class="error-message" id="nameError"></div>

            <label for="phone">Phone</label>
            <div style="display: flex; gap: 8px;">
                <select id="countryCode">
                    <option value="+91">+91 (India)</option>
                    <option value="+1">+1 (USA)</option>
                    <option value="+44">+44 (UK)</option>
                </select>
                <input id="phone" type="tel" placeholder="Mobile number" maxlength="10">
            </div>
            <div class="error-message" id="phoneError"></div>

            <label for="pincode">Pin Code</label>
            <input id="pincode" type="text" placeholder="Pincode" maxlength="6">
            <div class="error-message" id="pincodeError"></div>

            <label for="address">Full Address</label>
            <textarea id="address" rows="3" placeholder="House, street, city, state"></textarea>
            <div class="error-message" id="addressError"></div>

            <div class="row">
                <button class="checkout-btn" onclick="validateAndSave()">Save & Continue</button>
                <a href="cart.html" class="secondary-btn"><i class="fas fa-arrow-left"></i> Edit Cart</a>
            </div>
        </div>

        <div id="loadingOverlay">
            Processing Order... <br>
            <div id="countdown">5</div>
        </div>

        <div class="card" id="upiSection">
            <h2>Complete your payment via UPI and share the 12-digit reference number in the chat for order confirmation.</h2>
            <img src="ref.jpg" alt="UPI QR code for payment" onerror="this.src='image/default1.jpg';">
            <div class="priceDisplay" id="upiAmount"></div>
            <p>UPI ID: <strong>yourupiid@upi</strong></p>
            <label for="upiRef">Enter UPI Reference Number</label>
            <input id="upiRef" type="text" placeholder="Enter your UPI ref number" maxlength="12">
            <div class="error-message" id="upiRefError"></div>
            <button class="checkout-btn" onclick="confirmOrder()">Confirm Payment</button>
            <div class="imageHints">
                <p>Payment demo:</p>
                <iframe src="https://www.youtube.com/embed/ncCfznhMcWw" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>

        <div class="card" id="orderConfirm">
            <h2>✅ Order Confirmed</h2>
            <p>Your Order Number: <span id="orderNum"></span></p>
            <p id="orderDetails"></p>
            <p><strong>Confirmation Message:</strong> Your order is confirmed. Track your order status using the Order ID.</p>
            <div>
                <span class="copyNote">Copy this Order ID for tracking.</span><br>
                <span class="copyBtn" onclick="copyOrderID()"><i class="fas fa-copy"></i> Copy Order ID</span>
            </div>
            <a id="trackOrderBtn" href="tracking.html" class="track-btn"><i class="fas fa-location-arrow"></i> Track Your Order</a>

            <div class="imageHints">
                <p>How to track your order:</p>
                <iframe src="https://www.youtube.com/embed/ncCfznhMcWw" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <footer>
        © <span id="yr"></span> KHOZZA • All Rights Reserved
    </footer>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- REPLACE WITH YOUR ACTUAL FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7G-qFuj4e3H_UsTDTundsNlGyHQshEbo",
            authDomain: "admin-64dbd.firebaseapp.com",
            projectId: "admin-64dbd",
            storageBucket: "admin-64dbd.firebasestorage.app",
            messagingSenderId: "629728527109",
            appId: "1:629728527109:web:b44d10cbe8170021462d6c",
            measurementId: "G-EMP3S14ET1"
        };
        // --- ADMIN WHATSAPP NUMBER ---
        const ADMIN_WA_NUMBER = '918860039503'; // Use 91XXXXXXXXXX format

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables and Helper functions
        document.getElementById('yr').textContent = new Date().getFullYear();
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        let totalAmount = 0;
        let currentOrderId = null;

        function setFieldError(fieldId, message) {
            // ... (unchanged helper function)
        }

        function toggleMenu() {
             // ... (unchanged helper function)
        }

        function loadProductSummary() {
            // ... (unchanged function)
        }

        function generateOrderId() {
            // ... (unchanged function)
        }


        // --- CORE CHECKOUT FUNCTIONS ---

        async function validateAndSave(){
            // Clear previous errors
            ['name', 'phone', 'pincode', 'address'].forEach(id => setFieldError(id, ''));

            const name=document.getElementById('name').value.trim();
            const phone=document.getElementById('phone').value.trim();
            const countryCode=document.getElementById('countryCode').value;
            const pincode=document.getElementById('pincode').value.trim();
            const address=document.getElementById('address').value.trim();
            
            let isValid = true;

            // Validation logic
            if(!name) { setFieldError('name', 'Full Name is required.'); isValid = false; }
            if(!phone || !/^\d{10}$/.test(phone)) { setFieldError('phone', '10-digit phone number is required.'); isValid = false; }
            if(!pincode || !/^\d{6}$/.test(pincode)) { setFieldError('pincode', '6-digit Pincode is required.'); isValid = false; }
            if(!address) { setFieldError('address', 'Full Address is required.'); isValid = false; }
            if(cart.length === 0){ alert('Cart is empty. Please add products to cart.'); return; }

            if (!isValid) return;

            currentOrderId = generateOrderId();
            document.getElementById('loadingOverlay').style.display='flex';
            
            try {
                const orderData = {
                    orderId: currentOrderId,
                    customerName: name,
                    customerPhone: countryCode + phone,
                    customerAddress: address,
                    customerPincode: pincode,
                    totalAmount: totalAmount,
                    products: cart.map(item => ({
                        productName: item.name,
                        qty: parseInt(item.qty || 1),
                        size: item.size || 'N/A',
                        color: item.color || 'N/A',
                        price: parseFloat(item.price || 0)
                    })),
                    status: 'Details Submitted, Awaiting Payment',
                    timestamp: serverTimestamp()
                };

                await setDoc(doc(db, "orders", currentOrderId), orderData);
                
                document.getElementById('checkoutCard').style.display='none';

                let countdown=5;
                const interval=setInterval(()=>{
                    document.getElementById('countdown').textContent=countdown;
                    countdown--;
                    if(countdown<0){ 
                        clearInterval(interval); 
                        document.getElementById('loadingOverlay').style.display='none'; 
                        document.getElementById('upiSection').style.display='block'; 
                    }
                },1000);

            } catch (e) {
                console.error("Firebase save error:", e);
                alert('Order save failed. Please ensure your Firebase Security Rules are set correctly (allow write: if true).');
                document.getElementById('loadingOverlay').style.display='none';
                document.getElementById('checkoutCard').style.display='block';
            }
        }

        async function confirmOrder(){
            setFieldError('upiRef', '');
            const upiRef=document.getElementById('upiRef').value.trim();
            
            if(!upiRef || !/^\d{12}$/.test(upiRef)){ 
                setFieldError('upiRef', 'Please enter a valid 12-digit UPI Reference Number.');
                return; 
            }

            if (!currentOrderId) {
                alert('Order ID missing. Please go back and save details.');
                return;
            }

            try{
                // Update Order in Firebase with UPI Ref and Final Status
                await updateDoc(doc(db,"orders",currentOrderId),{
                    upiRef: upiRef,
                    status: 'Order Confirmed - Payment Ref Received',
                    paymentConfirmedAt: serverTimestamp()
                });

                // Clear Cart and Show Confirmation UI
                document.getElementById('upiSection').style.display='none';
                document.getElementById('orderConfirm').style.display='block';
                document.getElementById('orderNum').textContent=currentOrderId;
                document.getElementById('trackOrderBtn').href = `tracking.html?orderId=${currentOrderId}`;

                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('countryCode').value + document.getElementById('phone').value.trim();
                const pincode = document.getElementById('pincode').value.trim();
                const address = document.getElementById('address').value.trim();

                document.getElementById('orderDetails').innerHTML = `
                    Customer: ${name}<br>
                    Phone: ${phone}<br>
                    Address: ${address}, ${pincode}<br>
                    Total: ₹${totalAmount.toFixed(2)}
                `;

                // WhatsApp Redirect Message
                const message=encodeURIComponent(
                    `New Order Confirmed:\nOrder ID: ${currentOrderId}\n` +
                    `Total: ₹${totalAmount.toFixed(2)}\n` +
                    `UPI Ref: ${upiRef}\n` +
                    `Customer: ${name}\n` +
                    `Phone: ${phone}\n` +
                    `Address: ${address}, ${pincode}\n` +
                    `--- Items ---\n${cart.map(item => `${item.name} (Size: ${item.size || 'N/A'}, Color: ${item.color || 'N/A'}) × ${item.qty || 1}`).join('\n')}`
                );
                
                // Clear cart only after message is constructed
                localStorage.removeItem('cart'); 

                // Redirect to WhatsApp after a small delay
                setTimeout(() => {
                    window.location.href = `https://wa.me/${ADMIN_WA_NUMBER}?text=${message}`;
                }, 1500);

            }catch(e){ 
                console.error("Firebase update error:", e); 
                alert('Error confirming payment. Your details were saved, but please share the UPI Ref directly on WhatsApp.'); 
            }
        }

        function copyOrderID(){ 
            // ... (unchanged helper function)
        }

        window.onload=loadProductSummary;
        window.toggleMenu=toggleMenu;
        window.validateAndSave=validateAndSave;
        window.confirmOrder=confirmOrder;
        window.copyOrderID=copyOrderID;
    </script>
</body>
</html>
 Customer: ${name}<br>
                    Phone: ${phone}<br>
                    Address: ${address}, ${pincode}<br>
                    Total: ₹${totalAmount.toFixed(2)}
                `;

                // WhatsApp Redirect
                const adminNumber='918860039503'; 
                const message=encodeURIComponent(
                    `New Order Confirmed: ${currentOrderId}\n` +
                    `Total: ₹${totalAmount.toFixed(2)}\n` +
                    `UPI Ref: ${upiRef}\n` +
                    `Customer: ${name}\n` +
                    `Phone: ${phone}\n` +
                    `Address: ${address}, ${pincode}\n` +
                    `--- Items ---\n${cart.map(item => `${item.name} (Size: ${item.size || 'N/A'}, Color: ${item.color || 'N/A'}) × ${item.qty || 1}`).join('\n')}`
                );
                
                setTimeout(() => {
                    window.location.href = `https://wa.me/${adminNumber}?text=${message}`;
                }, 1500);

            }catch(e){ 
                console.error("Firebase update error:", e); 
                alert('Error confirming payment. Your details were saved, but please share the UPI Ref directly on WhatsApp.'); 
            }
        }

        function copyOrderID(){ 
            navigator.clipboard.writeText(document.getElementById('orderNum').textContent).then(()=>{ 
                alert('Order ID copied!'); 
            }).catch(()=>{ 
                alert('Failed to copy'); 
            }); 
        }

        window.onload=loadProductSummary;
        window.toggleMenu=toggleMenu;
        window.validateAndSave=validateAndSave;
        window.confirmOrder=confirmOrder;
        window.copyOrderID=copyOrderID;
    </script>
</body>
</html>
oneError').textContent = '';
                document.getElementById('pincodeError').textContent = '';
                document.getElementById('addressError').textContent = '';
                document.getElementById('name').setAttribute('aria-invalid', 'false');
                document.getElementById('phone').setAttribute('aria-invalid', 'false');
                document.getElementById('pincode').setAttribute('aria-invalid', 'false');
                document.getElementById('address').setAttribute('aria-invalid', 'false');

                let isValid = true;

                if (!name) {
                    document.getElementById('nameError').textContent = 'Full name is required.';
                    document.getElementById('name').setAttribute('aria-invalid', 'true');
                    isValid = false;
                }
                if (!phone || !/^\d{10}$/.test(phone)) {
                    document.getElementById('phoneError').textContent = 'Enter a valid 10-digit phone number.';
                    document.getElementById('phone').setAttribute('aria-invalid', 'true');
                    isValid = false;
                }
                if (!pincode || !/^\d{6}$/.test(pincode)) {
                    document.getElementById('pincodeError').textContent = 'Enter a valid 6-digit pincode.';
                    document.getElementById('pincode').setAttribute('aria-invalid', 'true');
                    isValid = false;
                }
                if (!address) {
                    document.getElementById('addressError').textContent = 'Full address is required.';
                    document.getElementById('address').setAttribute('aria-invalid', 'true');
                    isValid = false;
                }
                if (cart.length === 0) {
                    document.getElementById('productSummary').innerHTML = '<p style="color:var(--error);">Cart is empty. Please add items.</p>';
                    isValid = false;
                }

                if (!isValid) return;

                // Show loading overlay
                const loadingOverlay = document.getElementById('loadingOverlay');
                let countdown = 5;
                document.getElementById('countdown').textContent = countdown;
                loadingOverlay.style.display = 'flex';

                const countdownInterval = setInterval(() => {
                    countdown--;
                    document.getElementById('countdown').textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        loadingOverlay.style.display = 'none';
                        document.getElementById('checkoutCard').style.display = 'none';
                        document.getElementById('upiSection').style.display = 'block';
                    }
                }, 1000);

            } catch (e) {
                console.error('Error in validateAndSave:', e);
                document.getElementById('productSummary').innerHTML = '<p style="color:var(--error);">Error processing form. Please try again.</p>';
            }
        }

        // Confirm order and save to localStorage
        function confirmOrder() {
            try {
                const upiRef = document.getElementById('upiRef').value.trim();
                document.getElementById('upiRefError').textContent = '';
                document.getElementById('upiRef').setAttribute('aria-invalid', 'false');

                if (!upiRef || !/^\d{12}$/.test(upiRef)) {
                    document.getElementById('upiRefError').textContent = 'Enter a valid 12-digit UPI reference number.';
                    document.getElementById('upiRef').setAttribute('aria-invalid', 'true');
                    return;
                }

                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('countryCode').value + document.getElementById('phone').value.trim();
                const pincode = document.getElementById('pincode').value.trim();
                const address = document.getElementById('address').value.trim();
                const orderId = generateOrderId();

                let orders = JSON.parse(localStorage.getItem('khozzaOrders') || '[]');
                orders = deduplicateOrders(orders);

                cart.forEach(item => {
                    orders.push({
                        orderId,
                        product: item.name,
                        qty: item.qty || 1,
                        size: item.size || 'N/A',
                        color: item.color || 'N/A',
                        name,
                        phone,
                        address,
                        pincode,
                        upiRef,
                        totalAmount: (item.price || 0) * (item.qty || 1),
                        status: 'Order is Confirmed'
                    });
                });

                localStorage.setItem('khozzaOrders', JSON.stringify(orders));
                localStorage.removeItem('cart');

                // Show order confirmation
                document.getElementById('upiSection').style.display = 'none';
                document.getElementById('orderConfirm').style.display = 'block';
                document.getElementById('orderNum').textContent = orderId;
                document.getElementById('orderDetails').innerHTML = `
                    Customer: ${name}<br>
                    Phone: ${phone}<br>
                    Address: ${address}, ${pincode}<br>
                    Items: ${cart.map(item => `${item.name} (Size: ${item.size || 'N/A'}, Color: ${item.color || 'N/A'}) × ${item.qty || 1}`).join(', ')}<br>
                    Total: ₹${totalAmount.toFixed(2)}
                `;

                // WhatsApp redirect
                const adminNumber = '+918860039503';
                const message = encodeURIComponent(
                    `New Order: ${orderId}\n` +
                    `Customer: ${name}\n` +
                    `Phone: ${phone}\n` +
                    `Address: ${address}, ${pincode}\n` +
                    `UPI Reference: ${upiRef}\n` +
                    `Items:\n${cart.map(item => `${item.name} (Size: ${item.size || 'N/A'}, Color: ${item.color || 'N/A'}) × ${item.qty || 1}`).join('\n')}\n` +
                    `Total: ₹${totalAmount.toFixed(2)}`
                );
                setTimeout(() => {
                    window.location.href = `https://wa.me/${adminNumber}?text=${message}`;
                }, 2000);

            } catch (e) {
                console.error('Error in confirmOrder:', e);
                document.getElementById('upiRefError').textContent = 'Error confirming order. Please try again.';
            }
        }

        // Copy Order ID to clipboard
        function copyOrderID() {
            try {
                const orderId = document.getElementById('orderNum').textContent;
                navigator.clipboard.writeText(orderId).then(() => {
                    alert('Order ID copied to clipboard!');
                }).catch(err => {
                    console.error('Error copying Order ID:', err);
                    alert('Failed to copy Order ID.');
                });
            } catch (e) {
                console.error('Error in copyOrderID:', e);
            }
        }

        // Load product summary on page load
        window.onload = loadProductSummary;
    </script>
</body>
</html>
</html>>
</body>
</html>ody>
</html>ody>
</html>